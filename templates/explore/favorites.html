{% extends 'base.html' %}
{% load static %}

{% block title %}Meus Favoritos - MaricaCity{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/explore.css' %}">
{% endblock %}

{% block content %}
<div class="bg-dark text-white page-header-gradient">
  {% include 'includes/navbar.html' with login_form_id='favoritesLoginForm' username_field_id='favoritesUsername' password_field_id='favoritesPassword' %}

  <div class="container py-4">
    <div class="text-center">
      <h1 class="h3 fw-bold text-uppercase mb-2">
        <i class="bi bi-heart-fill me-2"></i>Meus Favoritos
      </h1>
      <p class="mb-0 text-white-50">
        {{ favorites_count }} lugar{% if favorites_count != 1 %}es{% endif %} salvo{% if favorites_count != 1 %}s{% endif %}
      </p>
    </div>
  </div>
</div>

<div class="container py-5">
  {% if favorites %}
  <div class="row g-4">
    {% for favorite in favorites %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card border-2 h-100 card-hover">
        {% if favorite.place.primary_image %}
        <img src="{{ favorite.place.primary_image.image.url }}" alt="{{ favorite.place.name }}" class="card-img-top" style="height: 240px; object-fit: cover;" loading="lazy">
        {% else %}
        <div class="bg-dark text-white d-flex align-items-center justify-content-center" style="height: 240px;">
          <span class="display-4 fw-bold">{{ favorite.place.name|first }}</span>
        </div>
        {% endif %}
        <div class="card-body">
          <h5 class="card-title fw-bold text-uppercase">{{ favorite.place.name }}</h5>
          <p class="card-text text-muted">{{ favorite.place.description|truncatewords:25 }}</p>
          {% if favorite.place.categories.exists %}
          <div class="d-flex flex-wrap gap-2 mb-3">
            {% for cat in favorite.place.categories.all|slice:":3" %}
            <span class="badge rounded-pill bg-light text-dark">
              {% if cat.icon %}{{ cat.icon }}{% endif %} {{ cat.name }}
            </span>
            {% endfor %}
          </div>
          {% endif %}
          <p class="text-muted small mb-3">
            Salvo em {{ favorite.created_at|date:"d M, Y" }}
          </p>
          <div class="d-flex gap-2">
            <a href="{% url 'explore:place_detail' favorite.place.pk %}" class="btn btn-dark btn-sm text-uppercase flex-grow-1">Ver Detalhes →</a>
            <button class="btn btn-outline-danger btn-sm favorite-btn"
                    data-place-id="{{ favorite.place.pk }}"
                    data-favorited="true"
                    data-remove-mode="true"
                    title="Remover dos favoritos">
              <i class="bi bi-heart-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- Empty state for when no favorites exist -->
  <div class="text-center py-5" id="emptyFavoritesState">
    <div class="display-1 mb-4">
      <i class="bi bi-heart"></i>
    </div>
    {% if not is_authenticated %}
    <p class="lead text-muted mb-2">Seus favoritos são salvos no seu navegador.</p>
    <p class="text-muted mb-4">Favoritos são armazenados localmente e disponíveis apenas neste dispositivo.</p>
    {% else %}
    <p class="lead text-muted mb-2">Você ainda não tem favoritos.</p>
    <p class="text-muted mb-4">Explore lugares incríveis e salve seus favoritos!</p>
    {% endif %}
    <a href="{% url 'explore:explore' %}" class="btn btn-dark btn-lg text-uppercase">
      <i class="bi bi-compass me-2"></i>Explorar Lugares
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Favorites UI is already loaded from base.html via favorites-ui.js -->
{% if not is_authenticated %}
<script>
  // For anonymous users, dynamically load favorites from localStorage
  document.addEventListener('DOMContentLoaded', async function() {
    const favoritePlaceIds = favoritesService.getFavorites();
    const emptyState = document.getElementById('emptyFavoritesState');
    const container = emptyState.parentElement;

    if (favoritePlaceIds.length === 0) {
      // Show empty state
      emptyState.classList.remove('d-none');
    } else {
      // Fetch place details for these IDs
      try {
        const response = await fetch(`/explorar/api/places-by-ids/?ids=${favoritePlaceIds.join(',')}`);
        const data = await response.json();

        if (data.places && data.places.length > 0) {
          // Hide empty state
          emptyState.remove();

          // Update favorites count in header
          const countElement = container.querySelector('.text-white-50');
          if (countElement) {
            const count = data.places.length;
            countElement.textContent = `${count} lugar${count !== 1 ? 'es' : ''} salvo${count !== 1 ? 's' : ''}`;
          }

          // Create places grid
          const gridHtml = `
            <div class="row g-4">
              ${data.places.map(place => `
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="card border-2 h-100 card-hover">
                    ${place.image_url
                      ? `<img src="${place.image_url}" alt="${place.name}" class="card-img-top" style="height: 240px; object-fit: cover;" loading="lazy">`
                      : `<div class="bg-dark text-white d-flex align-items-center justify-content-center" style="height: 240px;">
                           <span class="display-4 fw-bold">${place.name.charAt(0)}</span>
                         </div>`
                    }
                    <div class="card-body">
                      <h5 class="card-title fw-bold text-uppercase">${place.name}</h5>
                      <p class="card-text text-muted">${place.description.substring(0, 100)}${place.description.length > 100 ? '...' : ''}</p>
                      ${place.categories.length > 0
                        ? `<div class="d-flex flex-wrap gap-2 mb-3">
                             ${place.categories.slice(0, 3).map(cat => `
                               <span class="badge rounded-pill bg-light text-dark">
                                 ${cat.icon} ${cat.name}
                               </span>
                             `).join('')}
                           </div>`
                        : ''
                      }
                      <div class="d-flex gap-2">
                        <a href="${place.url}" class="btn btn-dark btn-sm text-uppercase flex-grow-1">Ver Detalhes →</a>
                        <button class="btn btn-outline-danger btn-sm favorite-btn"
                                data-place-id="${place.id}"
                                data-favorited="true"
                                data-remove-mode="true"
                                title="Remover dos favoritos">
                          <i class="bi bi-heart-fill"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;

          container.innerHTML = gridHtml;

          // Re-attach event listeners to favorite buttons
          const favoriteButtons = container.querySelectorAll('.favorite-btn');
          favoriteButtons.forEach(button => {
            button.addEventListener('click', async function(e) {
              e.preventDefault();
              e.stopPropagation();

              const placeId = button.dataset.placeId;
              favoritesService.removeFavorite(placeId);

              // Remove card with animation
              const card = button.closest('.col-12');
              if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';

                setTimeout(() => {
                  card.remove();

                  // Check if no more favorites
                  const remainingCards = container.querySelectorAll('.favorite-btn').length;
                  if (remainingCards === 0) {
                    location.reload(); // Reload to show empty state
                  } else {
                    // Update count
                    const countElement = document.querySelector('.text-white-50');
                    if (countElement) {
                      const newCount = remainingCards;
                      countElement.textContent = `${newCount} lugar${newCount !== 1 ? 'es' : ''} salvo${newCount !== 1 ? 's' : ''}`;
                    }
                  }
                }, 300);
              }
            });
          });
        } else {
          // No places found (might be deleted or unapproved)
          emptyState.classList.remove('d-none');
        }
      } catch (error) {
        console.error('Error loading favorites:', error);
        emptyState.classList.remove('d-none');
      }
    }
  });
</script>
{% endif %}
{% endblock %}
